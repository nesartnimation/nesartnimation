<script>
  const checkoutItems = document.getElementById('checkout-items');
  const checkoutEmpty = document.getElementById('checkout-empty');
  const checkoutTotal = document.getElementById('checkout-total');
  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  function updateGlobalCart() {
    // Actualiza contador global y modal si existen
    const cartCountEl = document.getElementById('cart-count');
    if(cartCountEl) cartCountEl.textContent = cart.reduce((sum,item)=>sum+item.quantity,0);

    // Guardar en localStorage
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function renderCheckout() {
    checkoutItems.innerHTML = '';
    if(cart.length === 0){
      checkoutEmpty.style.display = 'block';
      checkoutTotal.textContent = 'Total: 0€';
      updateGlobalCart();
      return;
    }
    checkoutEmpty.style.display = 'none';

    let total = 0;

    cart.forEach((item, index)=>{
      const subtotal = item.price * item.quantity;
      total += subtotal;

      const div = document.createElement('div');
      div.className = 'checkout-item';
      div.style.display='flex';
      div.style.alignItems='center';
      div.style.gap='15px';
      div.style.marginBottom='15px';

      div.innerHTML = `
        <div class="checkout-item-image">
          <img src="${item.image}" alt="${item.name}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;">
        </div>
        <div class="checkout-item-info" style="flex:1;">
          <h3>${item.name}</h3>
          <p>Precio: ${item.price}€</p>
          <div class="checkout-item-controls">
            <input type="number" min="1" max="${item.stock || 999}" value="${item.quantity}" data-index="${index}" style="width:60px;">
            <button data-index="${index}">✖</button>
          </div>
          <p class="checkout-subtotal">Subtotal: ${subtotal}€</p>
        </div>
      `;

      // Botón eliminar
      div.querySelector('button').addEventListener('click', ()=>{
        cart.splice(index, 1);
        renderCheckout();
      });

      // Cambiar cantidad
      div.querySelector('input').addEventListener('change', e=>{
        let val = parseInt(e.target.value);
        if(val < 1) val = 1;
        if(item.stock && val > item.stock) {
          alert(`Solo hay ${item.stock} unidades disponibles de ${item.name}`);
          val = item.stock;
        }
        item.quantity = val;
        renderCheckout();
      });

      checkoutItems.appendChild(div);
    });

    checkoutTotal.textContent = `Total: ${total}€`;
    updateGlobalCart();
  }

  renderCheckout();

  // Botón finalizar compra
  const checkoutBtn = document.querySelector('.checkout-button');
  if(checkoutBtn){
    checkoutBtn.addEventListener('click', ()=>{
      if(cart.length === 0){
        alert('Tu carrito está vacío');
        return;
      }
      alert('¡Compra realizada con éxito!');
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCheckout();
    });
  }
</script>
