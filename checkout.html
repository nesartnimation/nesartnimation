<!-- MODAL CHECKOUT -->
<div id="checkout-modal" class="cart-modal">
  <div class="cart-modal-content">
    <span class="checkout-close">&times;</span>
    <h2>Finalizar Compra</h2>

    <div class="checkout-container" style="display:flex; gap:20px; flex-wrap:wrap;">
      
      <!-- COLUMNA IZQUIERDA: RESUMEN DE COMPRA -->
      <div class="checkout-left" style="flex:1; min-width:300px;">
        <h3>Resumen de tu compra</h3>
        <ul id="checkout-cart-items" style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;"></ul>

        <div class="checkout-prices" style="margin-top:15px;">
          <p id="checkout-subtotal">Subtotal: 0€</p>
          <p id="checkout-vat">IVA 21%: 0€</p>
          <p id="checkout-shipping">Envío: 6€</p>
          <p id="checkout-total" style="font-weight:bold;">Total: 0€</p>
        </div>
      </div>

      <!-- COLUMNA DERECHA: DATOS DEL CLIENTE -->
      <div class="checkout-right" style="flex:1; min-width:300px;">
        <h3>Datos del Cliente</h3>
        <input type="text" id="client-name" placeholder="Nombre" required>
        <input type="email" id="client-email" placeholder="Email" required>
        <input type="tel" id="client-phone" placeholder="Número de teléfono" required>
        <input type="text" id="client-address" placeholder="Dirección" required>
        <input type="text" id="client-postal" placeholder="Código postal" required>
        <input type="text" id="client-country" placeholder="País" required>
        <input type="text" id="client-city" placeholder="Ciudad" required>
        <textarea id="client-message" placeholder="Mensaje (opcional)"></textarea>

        <!-- MÉTODOS DE PAGO CON GRÁFICOS -->
        <h3>Método de pago</h3>
        <div class="payment-methods" style="display:flex; gap:10px; margin-bottom:15px;">
          <button class="payment-btn" data-method="card" style="display:flex; align-items:center; gap:5px; padding:8px 12px; border:1px solid #ccc; border-radius:6px; cursor:pointer;">
            <img src="images/creditcard.svg" alt="Pago con tarjeta" style="width:24px;height:24px;">
            <span>Tarjeta</span>
          </button>
          <button class="payment-btn" data-method="paypal" style="display:flex; align-items:center; gap:5px; padding:8px 12px; border:1px solid #ccc; border-radius:6px; cursor:pointer;">
            <img src="images/paypal.svg" alt="Pago con PayPal" style="width:24px;height:24px;">
            <span>PayPal</span>
          </button>
        </div>

        <button id="checkout-confirm-btn" style="margin-top:15px; background:#ff4d4f; color:white; border:none; padding:10px 15px; border-radius:6px; cursor:pointer;">Confirmar Compra</button>
      </div>

    </div>
  </div>
</div>

<script>
  const checkoutItems = document.getElementById('checkout-items');
  const checkoutEmpty = document.getElementById('checkout-empty');
  const checkoutTotal = document.getElementById('checkout-total');
  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  function updateGlobalCart() {
    // Actualiza contador global y modal si existen
    const cartCountEl = document.getElementById('cart-count');
    if(cartCountEl) cartCountEl.textContent = cart.reduce((sum,item)=>sum+item.quantity,0);

    // Guardar en localStorage
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function renderCheckout() {
    checkoutItems.innerHTML = '';
    if(cart.length === 0){
      checkoutEmpty.style.display = 'block';
      checkoutTotal.textContent = 'Total: 0€';
      updateGlobalCart();
      return;
    }
    checkoutEmpty.style.display = 'none';

    let total = 0;

    cart.forEach((item, index)=>{
      const subtotal = item.price * item.quantity;
      total += subtotal;

      const div = document.createElement('div');
      div.className = 'checkout-item';
      div.style.display='flex';
      div.style.alignItems='center';
      div.style.gap='15px';
      div.style.marginBottom='15px';

      div.innerHTML = `
        <div class="checkout-item-image">
          <img src="${item.image}" alt="${item.name}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;">
        </div>
        <div class="checkout-item-info" style="flex:1;">
          <h3>${item.name}</h3>
          <p>Precio: ${item.price}€</p>
          <div class="checkout-item-controls">
            <input type="number" min="1" max="${item.stock || 999}" value="${item.quantity}" data-index="${index}" style="width:60px;">
            <button data-index="${index}">✖</button>
          </div>
          <p class="checkout-subtotal">Subtotal: ${subtotal}€</p>
        </div>
      `;

      // Botón eliminar
      div.querySelector('button').addEventListener('click', ()=>{
        cart.splice(index, 1);
        renderCheckout();
      });

      // Cambiar cantidad
      div.querySelector('input').addEventListener('change', e=>{
        let val = parseInt(e.target.value);
        if(val < 1) val = 1;
        if(item.stock && val > item.stock) {
          alert(`Solo hay ${item.stock} unidades disponibles de ${item.name}`);
          val = item.stock;
        }
        item.quantity = val;
        renderCheckout();
      });

      checkoutItems.appendChild(div);
    });

    checkoutTotal.textContent = `Total: ${total}€`;
    updateGlobalCart();
  }

  renderCheckout();

  // Botón finalizar compra
  const checkoutBtn = document.querySelector('#checkout-confirm-btn');
  if(checkoutBtn){
    checkoutBtn.addEventListener('click', ()=>{
      if(cart.length === 0){
        alert('Tu carrito está vacío');
        return;
      }
      alert('¡Compra realizada con éxito!');
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCheckout();
    });
  }
</script>
