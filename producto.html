<script>
  // =======================
  // VARIABLES DEL CARRITO
  // =======================
  const cartCount = document.getElementById('cart-count');
  const cartContainer = document.getElementById('cart');
  const cartModal = document.getElementById('cart-modal');
  const cartModalItems = document.getElementById('cart-modal-items');
  const cartModalTotal = document.getElementById('cart-modal-total');
  const cartModalEmpty = document.getElementById('cart-modal-empty');
  const cartModalClose = document.querySelector('.cart-close');
  const cartModalCheckout = document.getElementById('cart-modal-checkout');

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  function updateCart() {
    // Contador
    const total = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = total;

    // Modal
    renderCartModal();

    // Guardar
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function renderCartModal() {
    if(!cartModalItems) return;

    cartModalItems.innerHTML = '';

    if(cart.length === 0){
      cartModalEmpty.style.display='block';
      cartModalTotal.textContent='';
      return;
    }

    cartModalEmpty.style.display='none';

    let total = 0;
    cart.forEach(item=>{
      total += item.price * item.quantity;
      const li = document.createElement('li');
      li.innerHTML = `
        <img src="${item.image}" alt="${item.name}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;margin-right:10px;">
        <span>${item.name} - ${item.price}€ x ${item.quantity}</span>
      `;
      cartModalItems.appendChild(li);
    });

    cartModalTotal.textContent = `Total: ${total}€`;
  }

  updateCart();

  // =======================
  // CARGAR PRODUCTO
  // =======================
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');

  const titleEl = document.getElementById('product-title');
  const imgEl = document.getElementById('product-img');
  const priceEl = document.getElementById('product-price');
  const descEl = document.getElementById('product-description');
  const stockEl = document.getElementById('product-stock');
  const addBtn = document.getElementById('product-add-btn');

  fetch('data/products.json')
    .then(res => res.json())
    .then(products => {
      const product = products.find(p => p.id === productId);
      if(!product){
        titleEl.textContent = "Producto no encontrado";
        addBtn.disabled = true;
        return;
      }

      // Mostrar información
      titleEl.textContent = product.name;
      imgEl.src = product.image;
      imgEl.alt = product.name;
      priceEl.textContent = `Precio: ${product.price}€`;
      descEl.textContent = product.description || "Descripción pendiente";
      stockEl.textContent = `Stock: ${product.stock || '∞'}`;

      // =======================
      // BOTÓN AÑADIR AL CARRITO
      // =======================
      addBtn.addEventListener('click', ()=>{
        const existing = cart.find(item => item.id === product.id);
        const currentQty = existing ? existing.quantity : 0;

        if(currentQty + 1 > product.stock){
          alert(`No hay suficiente stock de ${product.name}. Disponible: ${product.stock}`);
          return;
        }

        if(existing){
          existing.quantity += 1;
        } else {
          cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.image,
            quantity: 1,
            stock: product.stock
          });
        }

        updateCart();
        // Mostramos el modal del carrito
        if(cartModal){
          cartModal.style.display='flex';
          cartModalEmpty.textContent='';
        }
      });
    })
    .catch(err=>{
      console.error(err);
      titleEl.textContent="Error cargando producto";
      addBtn.disabled = true;
    });

  // =======================
  // MODAL CARRITO
  // =======================
  if(cartModalClose) cartModalClose.addEventListener('click',()=>cartModal.style.display='none');
  if(cartModalCheckout){
    cartModalCheckout.addEventListener('click',()=>{
      if(cart.length===0){
        alert('Todavía no has añadido productos');
        return;
      }
      window.location.href='checkout.html';
    });
  }

  // Cerrar modal al click fuera
  window.addEventListener('click', e=>{
    if(e.target===cartModal) cartModal.style.display='none';
  });

  // Botón flotante del carrito
  if(cartContainer){
    cartContainer.addEventListener('click', ()=>{
      if(cart.length===0){
        cartModalEmpty.textContent='Todavía no has puesto nada en tu carrito';
        cartModalEmpty.style.display='block';
      }
      cartModal.style.display='flex';
    });
  }
</script>
